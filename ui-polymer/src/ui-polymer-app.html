<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="./consentua-icons.html">
<link rel="import" href="./consentua-binary-selector.html">
<link rel="import" href="./consentua-linear-selector.html">

<dom-module id="ui-polymer-app">
  <template>
    <style>
       :host {
        --consentua-main: #9A1144;
        --main-background-color: #e1e1e1;
        --green-l: #4CAF50;
        --green-d: #265728;
        font-family: 'Open Sans', sans-serif;
        width: 100%;
        max-width: 500px;
        margin: 5px auto;
        height: 100%;
        display: block;
        background-color: var(--main-background-color);
        padding: 1em 0em;
        --paper-toggle-button-checked-bar-color: var(--green-l);
        --paper-toggle-button-checked-button-color: var(--green-l);
        --paper-toggle-button-checked-ink-color: var(--green-l);
      }

      paper-button {
        background-color: var(--green-l);
        color: #fff;
        text-transform: capitalize;
        min-width: 22%;
      }

      .no-template {
        background-color: var(--consentua-main);
        text-align: center;
        color: #fff;
        padding: 2em;
        max-width: 40%;
        border-radius: 5px;
        margin: 0px auto;
      }

      .loading {
        height: 500px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .mixed-container {
        background-color: #fff;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.35);
        height: 670px;
        padding: 1em;
        margin: 0.5em;
        border-radius: 5px;
      }

      .mixed-groups-container {
        padding: 1.5em;
        background-color: #ddd;
        overflow-y: scroll;
        max-height: 500px;
      }

      .mixed-groups-container>div {
        margin-top: 40px;
      }
    </style>

    <app-location use-hash-as-path route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:view" data="{{routeData}}" tail="{{subroute}}">
    </app-route>

    <iron-pages selected="[[routeData.view]]" attr-for-selected="name" fallback-selection="none">
      <!-- Single binary pg -->
      <div name="binary">
        <consentua-binary-selector purpose-group="[[_getFirstPg(template.PurposeGroups)]]"></consentua-binary-selector>
      </div>
      <!-- Single linear pg -->
      <div name="linear">
        <consentua-linear-selector purpose-group="[[_getFirstPg(template.PurposeGroups)]]"></consentua-linear-selector>
      </div>
      <!-- Mixed/many pg -->
      <div name="mixed">
        <div class="mixed-container">
          <p>[[template.Question]]</p>
          <p>[[template.Explanation]]</p>
          <section class="mixed-groups-container">
            <template is="dom-repeat" items="[[template.PurposeGroups]]">
              <template is="dom-if" if="{{_isLinear(item.DisplayType)}}">
                <div>
                  <consentua-linear-selector purpose-group="[[item]]"></consentua-linear-selector>
                </div>
              </template>
              <template is="dom-if" if="{{_isBinary(item.DisplayType)}}">
                <div>
                  <consentua-binary-selector purpose-group="[[item]]"></consentua-binary-selector>
                </div>
              </template>
            </template>
          </section>
        </div>
      </div>
      <!-- no template/pg -->
      <div name="none" class="no-template">
        <iron-icon icon="consentua-icons:mood-bad"></iron-icon>
        <p>No consent templates found</p>
        <iron-icon icon="consentua-icons:logo"></iron-icon>
      </div>
    </iron-pages>


    <!-- loading -->
    <!-- <dom-if if="{{loading}}">
    <template>
      <div class="loading"><p>Loading Consentua..</p></div>
    </template>
  </dom-if> -->
    <!-- there is no template -->

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class UiPolymerApp extends Polymer.Element {
      static get is() {
        return 'ui-polymer-app';
      }
      static get properties() {
        return {
          template: {
            type: Object,
            notify: true
          },
          isTemplate: {
            type: Boolean,
            notify: true,
            value: false
          },
          loading: {
            type: Boolean,
            notify: true,
            value: true
          },
          route: {
            type: Object,
            notify: true
          },
          routeData: {
            type: Object,
            notify: true
          },
          subroute: {
            type: Object,
            notify: true
          }
        };
      }
      constructor() {
        super();
        this._boundListener = this._consentuaLoader.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();
        document.body.addEventListener('consentua-ready', this._boundListener);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        document.body.removeEventListener('consentua-ready', this._boundListener);
      }
      _consentuaLoader() {
        console.log("----------------------consentua on polymer ready!!-------------------")
        console.log("Consentua is ready", window.consentua);
        if (window.consentua.template) {
          this.template = window.consentua.template;
          this.isTemplate = true;
          console.log(this.template);
        } else{
          this.routeData.view = "none";
        }
        this.disconnectedCallback(); //stop listening for consentua-ready
      }
      _getFirstPg(pg) {
        return pg[0];
      }
      _isLinear(dt) {
        if (dt == 'linear' || dt == 'Linear' || dt == 'LINEAR') {
          return true;
        } else {
          return false;
        }
      }
      _isBinary(dt) {
        if (dt == 'binary' || dt == 'Binary' || dt == 'BINARY') {
          return true;
        } else {
          return false;
        }
      }
    }

    window.customElements.define(UiPolymerApp.is, UiPolymerApp);
  </script>
</dom-module>